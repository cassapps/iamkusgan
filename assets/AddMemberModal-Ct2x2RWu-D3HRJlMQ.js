import{C as m,m as B,Y,u as e,n as A,h as $,d as H,R as L,F as V,s as z}from"./index-MxoFyWhG.js";const{uploadMemberPhoto:G,saveMember:P,fetchMembersFresh:W}=L;function _({open:g,onClose:x,onSaved:v}){const[a,y]=m.useState({nickName:"",lastName:"",firstName:"",middleName:"",gender:"",birthday:"",street:"",brgy:"",municipality:"",email:"",mobile:"",validId:"",student:!1}),[N,S]=m.useState(""),[C,w]=m.useState(null),c=m.useRef(null),[k,M]=m.useState(!1),[r,R]=m.useState(!1),[I,j]=m.useState(""),[U,f]=m.useState(""),T=B(a.municipality),F=Y();m.useEffect(()=>{g||(y({nickName:"",lastName:"",firstName:"",middleName:"",gender:"",birthday:"",street:"",brgy:"",municipality:"",email:"",mobile:"",validId:"",student:!1}),S(""),w(null),j(""),f(""),c.current&&(URL.revokeObjectURL(c.current),c.current=null))},[g]);const d=i=>{const{name:o,value:l}=i.target;if(o==="student-select"){y(n=>({...n,student:String(l)==="Yes"}));return}if(o==="municipality"){y(n=>({...n,municipality:l,brgy:""}));return}y(n=>({...n,[o]:l}))},q=()=>M(!0),D=i=>{var o;try{const l=i.split(","),n=((o=l[0].match(/:(.*?);/))==null?void 0:o[1])||"image/jpeg",h=atob(l[1]),u=new Uint8Array(h.length);for(let t=0;t<h.length;t++)u[t]=h.charCodeAt(t);const p=new File([u],`passport-${Date.now()}.jpg`,{type:n});c.current&&(URL.revokeObjectURL(c.current),c.current=null);const s=URL.createObjectURL(p);c.current=s,w(p),S(s)}catch{}};m.useEffect(()=>()=>{c.current&&(URL.revokeObjectURL(c.current),c.current=null)},[]);function E(i,o=new Date){const l=String(i||"").replace(/[^A-Za-z0-9]/g,"").toUpperCase().slice(0,6),n=String(o.getFullYear()%100).padStart(2,"0"),h=String(o.getMonth()+1).padStart(2,"0"),u=String(o.getDate()).padStart(2,"0");return(l+n+h+u).slice(0,12)}const O=async i=>{var o;if((o=i==null?void 0:i.preventDefault)==null||o.call(i),!r){R(!0),j("");try{const l=String(a.nickName||"").trim().toUpperCase();if(!l)throw new Error("Nick Name is required");try{const t=await fetch(`/api/members/check?nick=${encodeURIComponent(l)}`);if(t&&t.ok&&(await t.json()).exists)throw new Error("Nick Name already taken")}catch{try{const t=await L.searchMembersByName(l);if(((t==null?void 0:t.rows)||[]).some(b=>String(b.NickName||b.nickName||b.nickname||b.nick_name||b.nick||"").toUpperCase()===l))throw new Error("Nick Name already taken")}catch{}}const n=new Date,h=E(l,n).toLowerCase();let u="";if(C){const t=await G(C,h);u=typeof t=="string"?t:(t==null?void 0:t.url)||""}const p={LastName:String(a.lastName||"").trim(),FirstName:String(a.firstName||"").trim(),MiddleName:String(a.middleName||"").trim(),NickName:l,Gender:a.gender,Birthday:a.birthday||"",Street:String(a.street||"").trim(),Brgy:String(a.brgy||"").trim(),Municipality:String(a.municipality||"").trim(),Email:String(a.email||"").trim(),Mobile:String(a.mobile||"").trim(),ValidID:String(a.validId||"").trim(),Student:a.student?"Yes":"No",PhotoURL:u,photourl:u,photo:u,MemberSince:n.toISOString()};try{V.addOptimisticMember({full_name:`${p.FirstName} ${p.LastName}`.trim(),plan:"Monthly"})}catch{}const s=await P(p);if(!(s!=null&&s.ok))throw new Error((s==null?void 0:s.error)||"Failed to save");f("Member added"),setTimeout(async()=>{try{await W()}catch{}try{v==null||v(s)}catch{}try{x==null||x()}catch{}try{const t=(s==null?void 0:s.id)||(s==null?void 0:s.row)&&(s.row.MemberID||s.row.memberId||s.row.id);if(t)try{F(`/members/${encodeURIComponent(String(t))}`,{state:{row:s.row}})}catch{}}catch{}f("")},600)}catch(l){const n=(l==null?void 0:l.message)||"Failed to save";j(n);try{z.emit("modal:error",{message:n,source:"AddMemberModal",error:String(l)})}catch{}}finally{R(!1)}}};return g?e.jsx(A,{open:g,onClose:x,title:"Add Member",width:1e3,noInternalScroll:!0,children:e.jsxs("form",{onSubmit:O,style:{width:"100%",padding:0,background:"transparent",border:"none",boxShadow:"none",overflow:"visible"},children:[I&&e.jsx("div",{className:"small-error",style:{marginBottom:8},children:I}),U&&e.jsx("div",{style:{position:"fixed",top:20,right:20,background:"#16a34a",color:"#fff",padding:"8px 12px",borderRadius:10,boxShadow:"0 6px 16px rgba(0,0,0,.15)",zIndex:1e4},children:U}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"240px 1fr",gap:16},children:[e.jsxs("div",{children:[e.jsx("div",{style:{width:240,height:240,border:"1px solid var(--light-border)",borderRadius:12,background:"#fafbff",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:N?e.jsx("img",{src:N,alt:"preview",style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx("div",{style:{color:"var(--muted)"},children:"No photo"})}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:10},children:e.jsx("button",{type:"button",className:"button",onClick:q,disabled:!0,title:"Camera disabled in this build",style:{flex:"1 1 auto",cursor:"not-allowed",opacity:.6},children:"ðŸ“· Open Camera"})})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1.2fr 1fr 160px",gap:12,alignItems:"end"},children:[e.jsxs("div",{className:"field",style:{margin:0},children:[e.jsx("label",{className:"label",children:"Nick Name *"}),e.jsx("input",{name:"nickName",value:a.nickName,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",style:{margin:0},children:[e.jsx("label",{className:"label",children:"Valid ID *"}),e.jsx("input",{name:"validId",value:a.validId,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",style:{margin:0},children:[e.jsx("label",{className:"label",children:"Student"}),e.jsxs("select",{name:"student-select",value:a.student?"Yes":"No",onChange:d,disabled:r,children:[e.jsx("option",{children:"No"}),e.jsx("option",{children:"Yes"})]})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Last Name *"}),e.jsx("input",{name:"lastName",value:a.lastName,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"First Name *"}),e.jsx("input",{name:"firstName",value:a.firstName,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Middle Name"}),e.jsx("input",{name:"middleName",value:a.middleName,onChange:d,disabled:r})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Birthday *"}),e.jsx("input",{type:"date",name:"birthday",value:a.birthday,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Gender *"}),e.jsxs("select",{name:"gender",value:a.gender,onChange:d,required:!0,disabled:r,children:[e.jsx("option",{value:""}),e.jsx("option",{children:"Male"}),e.jsx("option",{children:"Female"})]})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Mobile *"}),e.jsx("input",{name:"mobile",value:a.mobile,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{name:"email",type:"email",value:a.email,onChange:d,disabled:r})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 2fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Municipality / City"}),e.jsxs("select",{name:"municipality",value:a.municipality,onChange:d,disabled:r,children:[e.jsx("option",{value:""}),$.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Brgy."}),e.jsxs("select",{name:"brgy",value:a.brgy,onChange:d,disabled:r||!a.municipality,children:[e.jsx("option",{value:""}),T.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"House No. / Street Name / Sitio"}),e.jsx("input",{name:"street",value:a.street,onChange:d,disabled:r})]})]})]})]}),e.jsxs("div",{style:{marginTop:12,display:"flex",gap:10,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"back-btn",onClick:x,style:{background:"#e5e7eb",color:"#111",fontWeight:700},children:"Cancel"}),e.jsx("button",{type:"submit",className:"primary-btn",disabled:r,children:"Save"})]}),k&&e.jsx(H,{open:k,onClose:()=>M(!1),onCapture:D,aspectRatio:3/4,targetWidth:720,targetHeight:960})]})}):null}export{_ as default};
