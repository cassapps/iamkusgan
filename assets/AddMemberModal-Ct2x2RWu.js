import{r as m,g as P,u as Y,j as e,M as _,a as $,C as W,b as F,l as z,e as G}from"./index-BUkBzIyC.js";const{uploadMemberPhoto:H,saveMember:V,fetchMembersFresh:Z}=F;function Q({open:x,onClose:f,onSaved:N}){const[t,j]=m.useState({nickName:"",lastName:"",firstName:"",middleName:"",gender:"",birthday:"",street:"",brgy:"",municipality:"",email:"",mobile:"",validId:"",student:!1}),[S,k]=m.useState(""),[M,C]=m.useState(null),o=m.useRef(null),[I,U]=m.useState(!1),[r,L]=m.useState(!1),[R,v]=m.useState(""),[T,w]=m.useState(""),E=P(t.municipality),O=Y();m.useEffect(()=>{x||(j({nickName:"",lastName:"",firstName:"",middleName:"",gender:"",birthday:"",street:"",brgy:"",municipality:"",email:"",mobile:"",validId:"",student:!1}),k(""),C(null),v(""),w(""),o.current&&(URL.revokeObjectURL(o.current),o.current=null))},[x]);const d=i=>{const{name:c,value:s}=i.target;if(c==="student-select"){j(n=>({...n,student:String(s)==="Yes"}));return}if(c==="municipality"){j(n=>({...n,municipality:s,brgy:""}));return}j(n=>({...n,[c]:s}))},q=()=>U(!0),B=i=>{var c;try{const s=i.split(","),n=((c=s[0].match(/:(.*?);/))==null?void 0:c[1])||"image/jpeg",h=atob(s[1]),b=new Uint8Array(h.length);for(let a=0;a<h.length;a++)b[a]=h.charCodeAt(a);const u=new File([b],`passport-${Date.now()}.jpg`,{type:n});o.current&&(URL.revokeObjectURL(o.current),o.current=null);const p=URL.createObjectURL(u);o.current=p,C(u),k(p)}catch{}};m.useEffect(()=>()=>{o.current&&(URL.revokeObjectURL(o.current),o.current=null)},[]);function D(i,c=new Date){const n=String(i||"").replace(/[^A-Za-z0-9]/g,"").toUpperCase().slice(0,6),h=String(c.getFullYear()%100).padStart(2,"0"),b=String(c.getMonth()+1).padStart(2,"0"),u=String(c.getDate()).padStart(2,"0");return(n+h+b+u).slice(0,12)}const A=async i=>{var c;if((c=i==null?void 0:i.preventDefault)==null||c.call(i),!r){L(!0),v("");try{const s=String(t.nickName||"").trim().toUpperCase();if(!s)throw new Error("Nick Name is required");try{const l=await fetch(`/api/members/check?nick=${encodeURIComponent(s)}`);if(l&&l.ok&&(await l.json()).exists)throw new Error("Nick Name already taken")}catch{try{const g=await F.searchMembersByName(s);if(((g==null?void 0:g.rows)||[]).some(y=>String(y.NickName||y.nickName||y.nickname||y.nick_name||y.nick||"").toUpperCase()===s))throw new Error("Nick Name already taken")}catch{}}const n=new Date,b=D(s,n).toLowerCase();let u="";if(M){const l=await H(M,b);u=typeof l=="string"?l:(l==null?void 0:l.url)||""}const p={LastName:String(t.lastName||"").trim(),FirstName:String(t.firstName||"").trim(),MiddleName:String(t.middleName||"").trim(),NickName:s,Gender:t.gender,Birthday:t.birthday||"",Street:String(t.street||"").trim(),Brgy:String(t.brgy||"").trim(),Municipality:String(t.municipality||"").trim(),Email:String(t.email||"").trim(),Mobile:String(t.mobile||"").trim(),ValidID:String(t.validId||"").trim(),Student:t.student?"Yes":"No",PhotoURL:u,photourl:u,photo:u,MemberSince:n.toISOString()};try{z.addOptimisticMember({full_name:`${p.FirstName} ${p.LastName}`.trim(),plan:"Monthly"})}catch{}const a=await V(p);if(!(a!=null&&a.ok))throw new Error((a==null?void 0:a.error)||"Failed to save");w("Member added"),setTimeout(async()=>{try{await Z()}catch{}try{N==null||N(a)}catch{}try{f==null||f()}catch{}try{const l=(a==null?void 0:a.id)||(a==null?void 0:a.row)&&(a.row.MemberID||a.row.memberId||a.row.id);if(l)try{O(`/members/${encodeURIComponent(String(l))}`,{state:{row:a.row}})}catch{}}catch{}w("")},600)}catch(s){const n=(s==null?void 0:s.message)||"Failed to save";v(n);try{G.emit("modal:error",{message:n,source:"AddMemberModal",error:String(s)})}catch{}}finally{L(!1)}}};return x?e.jsx(_,{open:x,onClose:f,title:"Add Member",width:1e3,noInternalScroll:!0,children:e.jsxs("form",{onSubmit:A,style:{width:"100%",padding:0,background:"transparent",border:"none",boxShadow:"none",overflow:"visible"},children:[R&&e.jsx("div",{className:"small-error",style:{marginBottom:8},children:R}),T&&e.jsx("div",{style:{position:"fixed",top:20,right:20,background:"#16a34a",color:"#fff",padding:"8px 12px",borderRadius:10,boxShadow:"0 6px 16px rgba(0,0,0,.15)",zIndex:1e4},children:T}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"240px 1fr",gap:16},children:[e.jsxs("div",{children:[e.jsx("div",{style:{width:240,height:240,border:"1px solid var(--light-border)",borderRadius:12,background:"#fafbff",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:S?e.jsx("img",{src:S,alt:"preview",style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx("div",{style:{color:"var(--muted)"},children:"No photo"})}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:10},children:e.jsx("button",{type:"button",className:"button",onClick:q,disabled:!0,title:"Camera disabled in this build",style:{flex:"1 1 auto",cursor:"not-allowed",opacity:.6},children:"ðŸ“· Open Camera"})})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1.2fr 1fr 160px",gap:12,alignItems:"end"},children:[e.jsxs("div",{className:"field",style:{margin:0},children:[e.jsx("label",{className:"label",children:"Nick Name *"}),e.jsx("input",{name:"nickName",value:t.nickName,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",style:{margin:0},children:[e.jsx("label",{className:"label",children:"Valid ID *"}),e.jsx("input",{name:"validId",value:t.validId,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",style:{margin:0},children:[e.jsx("label",{className:"label",children:"Student"}),e.jsxs("select",{name:"student-select",value:t.student?"Yes":"No",onChange:d,disabled:r,children:[e.jsx("option",{children:"No"}),e.jsx("option",{children:"Yes"})]})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Last Name *"}),e.jsx("input",{name:"lastName",value:t.lastName,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"First Name *"}),e.jsx("input",{name:"firstName",value:t.firstName,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Middle Name"}),e.jsx("input",{name:"middleName",value:t.middleName,onChange:d,disabled:r})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Birthday *"}),e.jsx("input",{type:"date",name:"birthday",value:t.birthday,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Gender *"}),e.jsxs("select",{name:"gender",value:t.gender,onChange:d,required:!0,disabled:r,children:[e.jsx("option",{value:""}),e.jsx("option",{children:"Male"}),e.jsx("option",{children:"Female"})]})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Mobile *"}),e.jsx("input",{name:"mobile",value:t.mobile,onChange:d,required:!0,disabled:r})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{name:"email",type:"email",value:t.email,onChange:d,disabled:r})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 2fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Municipality / City"}),e.jsxs("select",{name:"municipality",value:t.municipality,onChange:d,disabled:r,children:[e.jsx("option",{value:""}),$.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"Brgy."}),e.jsxs("select",{name:"brgy",value:t.brgy,onChange:d,disabled:r||!t.municipality,children:[e.jsx("option",{value:""}),E.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"label",children:"House No. / Street Name / Sitio"}),e.jsx("input",{name:"street",value:t.street,onChange:d,disabled:r})]})]})]})]}),e.jsxs("div",{style:{marginTop:12,display:"flex",gap:10,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"back-btn",onClick:f,style:{background:"#e5e7eb",color:"#111",fontWeight:700},children:"Cancel"}),e.jsx("button",{type:"submit",className:"primary-btn",disabled:r,children:"Save"})]}),I&&e.jsx(W,{open:I,onClose:()=>U(!1),onCapture:B,aspectRatio:3/4,targetWidth:720,targetHeight:960})]})}):null}export{Q as default};
